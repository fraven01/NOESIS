{% extends 'base.html' %}
{% load recording_extras %}
{% block title %}Gutachten anzeigen{% endblock %}
{% block content %}
<h1 class="text-2xl font-semibold mb-4">Gutachten für {{ projekt.title }}</h1>
<div class="card">
    <div class="prose dark:prose-invert max-w-none">{{ text|markdownify }}</div>
    <div class="mt-4 flex space-x-2">
        <a href="{% url 'gutachten_edit' gutachten.id %}" class="btn-action">Bearbeiten</a>
        <a href="{% url 'gutachten_download' gutachten.id %}" class="btn-action">Download</a>
    </div>
    {% if projekt.gutachten_function_note %}
    <div class="mt-4">
        <label class="font-semibold">LLM-Vorschlag:</label>
          <textarea class="border-gray-300 dark:border-gray-600 bg-background dark:bg-background-dark text-gray-900 dark:text-gray-100 rounded w-full p-2 focus:border-primary dark:focus:border-primary focus:ring-primary dark:focus:ring-primary focus:ring-offset-2 dark:focus:ring-offset-gray-800" rows="6" readonly>{{ projekt.gutachten_function_note }}</textarea>
    </div>
    {% endif %}
    <form id="llm-check-form" class="mt-4">
        {% csrf_token %}
        <label class="font-semibold">LLM-Modell:</label>
        {% for key, data in categories.items %}
            <label class="ml-2">
                <input type="radio" name="model_category" value="{{ key }}" {% if key == category %}checked{% endif %}>
                {{ data.label }}
            </label>
        {% endfor %}
        <button type="button" id="llm-check-btn" class="btn btn-primary ml-2">LLM-Funktionscheck</button>
    </form>
</div>
<script>
document.getElementById('llm-check-btn').addEventListener('click',function(){
    const btn=this;
    const form=document.getElementById('llm-check-form');
    showSpinner(btn,'Prüfe...');
    fetch('{% url 'gutachten_llm_check' gutachten.id %}',{
        method:'POST',
        headers:{'X-CSRFToken':getCookie('csrftoken')},
        body:new FormData(form)
    }).then(r=>{if(!r.ok) throw new Error(); return r.text();}).then(()=>window.location.reload()).catch(()=>{alert('Fehler beim Prüfen'); hideSpinner(btn);});
});
</script>
{% endblock %}
