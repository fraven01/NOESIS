{% extends 'base.html' %}
{% load recording_extras %}
{% block title %}Anlage 2 Review{% endblock %}
{% block content %}
<h1 class="text-2xl font-semibold mb-4">Anlage 2 Funktionen pr√ºfen</h1>
<form method="post" class="space-y-4" data-anlage-id="{{ anlage.pk }}">
    {% csrf_token %}
    <div class="filter-controls mb-2">
        <label>
            <input type="checkbox" id="show-relevant-only-filter" class="mr-2">
            Nur als "vorhanden" markierte Funktionen anzeigen
        </label>
        <button type="button" id="btn-verify-all" class="bg-green-600 text-white px-2 py-1 rounded ml-4">Alle Funktionen pr√ºfen ü§ñ</button>
    </div>
    <div class="mb-3">
        <button type="button" id="expand-all-subquestions" class="bg-gray-300 text-black px-2 py-1 rounded">Alle aufklappen</button>
        <button type="button" id="collapse-all-subquestions" class="bg-gray-300 text-black px-2 py-1 rounded">Alle einklappen</button>
    </div>
    <table class="table-auto w-full border">
        <thead>
            <tr>
                <th class="border px-2">Funktion</th>
                <th class="border px-2">Aktion</th>
                {% for label in labels %}
                <th class="border px-2">{{ label }} (Analyse)</th>
                {% endfor %}
                {% for label in labels %}
                <th class="border px-2">{{ label }} (Review)</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
        {% for row in rows %}
            <tr class="{% if row.sub %}subquestion-row hidden-row subquestions-for-{{ row.func_id }}{% endif %}" data-relevant="{{ row.analysis|get_item:'technisch_vorhanden'|yesno:'true,false,unknown' }}" data-parsed-status="{{ row.analysis|get_item:'technisch_vorhanden'|yesno:'True,False,None' }}" data-parsed-notes="{{ row.analysis|raw_item:'technisch_vorhanden'|get_item:'note' }}" data-func-id="{{ row.func_id }}" {% if row.sub %}data-sub-id="{{ row.sub_id }}"{% endif %}>
                <td class="border px-2 {% if row.sub %}pl-8{% endif %}">
                    {% if not row.sub %}
                    <button class="btn btn-sm btn-light toggle-button mr-2" type="button" data-target-class="subquestions-for-{{ row.func_id }}">+</button>
                    {% endif %}
                    {{ row.name }}
                    {% if row.ki_begruendung_html %}
                    <button type="button" class="btn btn-sm btn-outline-info open-justification-modal ms-2"
                            data-bs-toggle="modal"
                            data-bs-target="#justificationModal"
                            data-function-name="{{ row.name }}"
                            data-justification-html="{{ row.ki_begruendung_html|escape }}">
                        ‚ìò Begr√ºndung
                    </button>
                    {% endif %}
                    <span class="text-muted small source-indicator">(Quelle: {{ row.source_text }})</span>
                </td>
                <td class="border px-2 text-center">
                    <div class="dropdown">
                        <button class="btn btn-sm btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">ü§ñ</button>
                        <ul class="dropdown-menu">
                            <li><button type="button" class="dropdown-item verify-single-feature-btn"
                                data-project-file-id="{{ anlage.pk }}"
                                data-function-id="{{ row.func_id }}"
                                {% if row.sub %}data-subquestion-id="{{ row.sub_id }}"{% endif %}>KI-Pr√ºfung starten</button></li>
                            {% if row.ki_begruendung %}
                            <li>
                                <a class="dropdown-item" href="{% url 'edit_ki_justification' anlage.pk %}?{% if row.sub %}subquestion={{ row.sub_id }}{% else %}function={{ row.func_id }}{% endif %}">Begr√ºndung bearbeiten</a>
                            </li>
                            {% endif %}
                        </ul>
                    </div>
                </td>
                {% for field in fields %}
                {% with val=row.initial|get_item:field %}
                <td class="border px-2 text-center">
                    {% if val == True %}
                        <span class="status-badge status-ja">‚úì Vorhanden</span>
                    {% elif val == False %}
                        <span class="status-badge status-nein">‚úó Nicht vorhanden</span>
                    {% else %}
                        <span class="status-badge status-unbekannt">? Unbekannt</span>
                    {% endif %}
                </td>
                {% endwith %}
                {% endfor %}
                {% for f in row.form_fields %}
                <td class="border px-2 text-center">
                    {{ f.widget }}
                    {% if f.source %}<span class="text-xs text-gray-500">(Quelle: {{ f.source }})</span>{% endif %}
                </td>
                {% endfor %}
            </tr>
        {% endfor %}
        </tbody>
    </table>
    <div class="space-x-2 mt-2">
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Speichern</button>
        <button type="button" id="reset-fields" class="bg-gray-300 text-black px-4 py-2 rounded">Reset</button>
        <button type="button" id="btn-reset-all-reviews" class="bg-gray-300 text-black px-4 py-2 rounded">Alle Bewertungen zur√ºcksetzen</button>
    </div>
</form>
<div class="modal fade" id="justificationModal" tabindex="-1" aria-labelledby="justificationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="justificationModalLabel">Begr√ºndung</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
document.getElementById('show-relevant-only-filter').addEventListener('change', function() {
    const rows = document.querySelectorAll('tbody tr');
    rows.forEach(tr => {
        const relevant = tr.dataset.relevant;
        if (this.checked && relevant !== 'true') {
            tr.style.display = 'none';
        } else {
            tr.style.display = '';
        }
    });
});

const initialStates = {};
document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
    initialStates[cb.name] = cb.checked;
});
document.getElementById('reset-fields').addEventListener('click', () => {
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.checked = !!initialStates[cb.name];
    });
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

// Funktion zum Aktualisieren einer einzelnen Tabellenzeile mit einem neuen Ergebnis
function updateRowUI(row, resultData) {
    if (!row || !resultData) return;

    const newStatus = resultData.technisch_verfuegbar;
    const statusRadios = row.querySelectorAll('input[type="radio"][name*="-status"]');

    // Setze den Radio-Button entsprechend dem Ergebnis
    let aRadioWasSet = false;
    statusRadios.forEach(radio => {
        if (radio.value.toLowerCase() === String(newStatus).toLowerCase()) {
            radio.checked = true;
            aRadioWasSet = true;
        }
    });

    if (!aRadioWasSet) {
        statusRadios.forEach(radio => radio.checked = false);
    }

    // Aktualisiere die Quellen-Anzeige und andere UI-Elemente
    const sourceSpan = row.querySelector('.source-indicator');
    if (sourceSpan) {
        sourceSpan.textContent = '(Quelle: KI-Pr√ºfung)';
    }
}


// Auf- und Zuklappen aller Unterfragen ohne Bootstrap
document.addEventListener('DOMContentLoaded', function() {
    const expandAllBtn = document.getElementById('expand-all-subquestions');
    const collapseAllBtn = document.getElementById('collapse-all-subquestions');
    const individualToggleButtons = document.querySelectorAll('.toggle-button');

    // Logik f√ºr individuelle Schalter
    individualToggleButtons.forEach(button => {
        button.addEventListener('click', function() {
            const targetClass = this.dataset.targetClass;
            const subquestionRows = document.querySelectorAll('.' + targetClass);

            let isHidden = Array.from(subquestionRows).some(row => row.classList.contains('hidden-row'));

            subquestionRows.forEach(row => {
                row.classList.toggle('hidden-row');
            });

            this.textContent = isHidden ? '-' : '+';
        });
    });

    // Logik f√ºr "Alles aufklappen"
    if (expandAllBtn) {
        expandAllBtn.addEventListener('click', function() {
            document.querySelectorAll('.subquestion-row').forEach(row => {
                row.classList.remove('hidden-row');
            });
            individualToggleButtons.forEach(btn => btn.textContent = '-');
        });
    }

    // Logik f√ºr "Alles einklappen"
    if (collapseAllBtn) {
        collapseAllBtn.addEventListener('click', function() {
            document.querySelectorAll('.subquestion-row').forEach(row => {
                row.classList.add('hidden-row');
            });
            individualToggleButtons.forEach(btn => btn.textContent = '+');
        });
    }
});

// Event-Listener f√ºr Verifizierungs-Buttons
function startAndMonitorVerification(button) {
    const row = button.closest('tr');

    // UI sofort auf Ladezustand setzen
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

    // Daten f√ºr den Request aus dem geklickten Button extrahieren
    const { projectFileId, functionId, subquestionId } = button.dataset;
    const url = `/work/anlage/${projectFileId}/verify-feature/`;

    const body = new FormData();
    if (functionId) {
        body.append('function_id', functionId);
    }
    if (subquestionId) {
        body.append('subquestion_id', subquestionId);
    }

    fetch(url, {
        method: 'POST',
        body: body,
        headers: { 'X-CSRFToken': csrftoken }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.status === 'queued' && data.task_id) {
            const intervalId = setInterval(() => {
                fetch(`/ajax/task-status/${data.task_id}/`)
                    .then(res => res.json())
                    .then(taskData => {
                        if (taskData.status === 'SUCCESS') {
                            clearInterval(intervalId);
                            // updateRowUI(row, taskData.result);
                            button.innerHTML = '‚úì';
                            setTimeout(() => { button.innerHTML = 'ü§ñ'; button.disabled = false; }, 2000);
                        } else if (taskData.status === 'FAILURE') {
                            clearInterval(intervalId);
                            button.innerHTML = '‚ö†Ô∏è';
                            button.disabled = false;
                        }
                    });
            }, 5000);
        } else {
            button.innerHTML = '‚ö†Ô∏è';
            button.disabled = false;
        }
    })
    .catch(error => {
        console.error('Fehler bei der KI-Pr√ºfung:', error);
        button.innerHTML = '‚ö†Ô∏è';
        button.disabled = false;
    });
}

document.querySelectorAll('.verify-single-feature-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        startAndMonitorVerification(this);
    });
});

const verifyAllBtn = document.getElementById('btn-verify-all');
if (verifyAllBtn) {
    verifyAllBtn.addEventListener('click', function() {
        document.querySelectorAll('.verify-single-feature-btn').forEach(btn => {
            btn.click();
        });
    });
}

// Reset all review fields to parsed values
document.addEventListener('DOMContentLoaded', function() {
    const resetButton = document.getElementById('btn-reset-all-reviews');

    if (resetButton) {
        resetButton.addEventListener('click', function() {
            // 1. Selektiere alle Tabellenzeilen, die Analyse-Daten enthalten.
            const rows = document.querySelectorAll('tbody tr[data-parsed-status]');

            if (rows.length === 0) {
                alert('Keine Analyse-Daten zum Zur√ºcksetzen gefunden.');
                return;
            }

            // 2. Iteriere √ºber jede dieser Zeilen.
            rows.forEach(row => {
                // 1. Lies den urspr√ºnglichen Status aus dem data-Attribut.
                const parsedStatus = row.dataset.parsedStatus;
                const notesTextarea = row.querySelector('textarea[name*="-notes"]'); // Optional f√ºr Notizen

                // 2. Finde die Radio-Buttons INNERHALB der aktuellen Zeile.
                const statusRadios = row.querySelectorAll('input[type="radio"][name*="-status"]');

                if (statusRadios.length > 0) {
                    let aRadioWasSet = false; // Flag, um zu pr√ºfen, ob eine Aktion ausgef√ºhrt wurde.

                    // 3. Iteriere √ºber die Radio-Buttons, um den richtigen zu finden.
                    statusRadios.forEach(radio => {
                        // Vergleiche den Wert des Buttons mit dem gespeicherten Status
                        if (radio.value.toLowerCase() === parsedStatus.toLowerCase()) {
                            radio.checked = true;
                            aRadioWasSet = true;
                        }
                    });

                    // 4. KORREKTUR: Wenn kein passender Button gefunden wurde (z.B. weil parsedStatus leer war),
                    // stelle sicher, dass kein Button mehr ausgew√§hlt ist.
                    if (!aRadioWasSet) {
                       statusRadios.forEach(radio => {
                           radio.checked = false;
                       });
                    }
                }

                // Optional: Setze auch das Notiz-Feld zur√ºck
                if (notesTextarea) {
                    notesTextarea.value = row.dataset.parsedNotes || "";
                }
            });

            // Informiere den Benutzer, dass die Aktion erfolgreich war.
            alert('Alle Bewertungen wurden auf die urspr√ºnglichen Analysewerte zur√ºckgesetzt.');
        });
    }
});

// -------------------- Auto-Save Logic --------------------
const autoSaveUrl = '{% url "ajax_save_review_item" %}';
const formEl = document.querySelector('form[data-anlage-id]');
const projectFileId = formEl ? formEl.dataset.anlageId : null;

function showSaveStatus(el, text, color='black') {
    let span = el.parentNode.querySelector('.save-status');
    if (!span) {
        span = document.createElement('span');
        span.className = 'save-status ml-2 text-sm';
        el.parentNode.appendChild(span);
    }
    span.textContent = text;
    span.style.color = color;
    if (text.startsWith('‚úì')) {
        setTimeout(() => span.remove(), 1500);
    }
}

function autoSave(inputEl) {
    const row = inputEl.closest('tr');
    if (!row || !projectFileId) return;
    const funcId = row.dataset.funcId;
    const subId = row.dataset.subId;
    const statusRadio = row.querySelector('input[type="radio"][name*="-status"]:checked');
    const statusVal = statusRadio ? statusRadio.value : null;
    const notesEl = row.querySelector('textarea[name*="-notes"]');
    const notesVal = notesEl ? notesEl.value : '';

    const payload = {
        project_file_id: projectFileId,
        function_id: funcId,
        subquestion_id: subId,
        status: statusVal,
        notes: notesVal
    };

    showSaveStatus(inputEl, 'Speichere...');
    fetch(autoSaveUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(payload)
    })
        .then(resp => resp.ok ? resp.json() : Promise.reject())
        .then(() => showSaveStatus(inputEl, '‚úì Gespeichert', 'green'))
        .catch(() => showSaveStatus(inputEl, 'Fehler beim Speichern', 'red'));
}

document.querySelector('tbody').addEventListener('change', function(e) {
    const t = e.target;
    if (t.matches('input[type="radio"][name*="-status"], input[type="checkbox"]')) {
        autoSave(t);
    }
});

document.querySelector('tbody').addEventListener('blur', function(e) {
    const t = e.target;
    if (t.matches('textarea[name*="-notes"]')) {
        autoSave(t);
    }
}, true);

// Bootstrap-Tooltips initialisieren
document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
    new bootstrap.Tooltip(el, {html: true});
});

const justificationModal = document.getElementById('justificationModal');
if (justificationModal) {
    justificationModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const functionName = button.dataset.functionName;
        const justificationHtml = new DOMParser().parseFromString(button.dataset.justificationHtml, 'text/html').documentElement.textContent;
        const modalTitle = justificationModal.querySelector('.modal-title');
        const modalBody = justificationModal.querySelector('.modal-body');

        modalTitle.textContent = 'Begr√ºndung f√ºr: ' + functionName;
        modalBody.innerHTML = justificationHtml;
    });
}
</script>
{% endblock %}
