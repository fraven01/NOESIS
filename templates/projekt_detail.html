{% extends 'base.html' %}
{% block title %}Projekt {{ projekt.title }}{% endblock %}
{% block content %}
<h1 class="text-2xl font-semibold mb-4">{{ projekt.title }}</h1>
<p class="mb-2"><strong>Aktueller Status:</strong> {{ projekt.get_status_display }}</p>
<p class="mb-2"><strong>Beschreibung:</strong> {{ projekt.beschreibung }}</p>
<p class="mb-2"><strong>Software-Typen:</strong> {{ projekt.software_typen }}</p>
<form method="post" action="{% url 'projekt_status_update' projekt.pk %}" class="mb-4">
    {% csrf_token %}
    <label for="status" class="font-semibold">Status:</label>
    <select id="status" name="status" class="border rounded p-2">
    {% for val,label in status_choices %}
        <option value="{{ val }}" {% if projekt.status == val %}selected{% endif %}>{{ label }}</option>
    {% endfor %}
    </select>
    <button type="submit" class="bg-blue-600 text-white px-2 py-1 rounded ml-2">Aktualisieren</button>
</form>
<p class="mb-4">
    {% if projekt.gutachten_file %}
        <a href="{% url 'gutachten_view' projekt.pk %}" class="text-blue-700 underline">Gutachten anzeigen</a> |
        <a href="{% url 'gutachten_edit' projekt.pk %}" class="text-blue-700 underline">Bearbeiten</a> |
        <a href="{{ projekt.gutachten_file.url }}" class="text-blue-700 underline">Download</a>
        <form method="post" action="{% url 'gutachten_delete' projekt.pk %}" class="inline-block ml-2">
            {% csrf_token %}
            <button type="submit" class="text-red-700 underline">Löschen</button>
        </form>
    {% else %}
        <a href="{% url 'projekt_gutachten' projekt.pk %}" class="text-blue-700 underline">Gutachten erstellen</a>
    {% endif %}
</p>
<p class="mb-4">
    <a href="{% url 'projekt_gap_analysis' projekt.pk %}" class="text-blue-700 underline">Gap-Analyse herunterladen</a>
    |
    <a href="{% url 'projekt_management_summary' projekt.pk %}" class="text-blue-700 underline">Management Summary herunterladen</a>
</p>
<h2 class="text-xl font-semibold mt-4">Anlagen</h2>
<ul class="list-disc pl-5 mb-4">
    {% for a in projekt.anlagen.all %}
    <li class="mb-2">
        Anlage {{ a.anlage_nr }}:
        <a href="{{ a.upload.url }}" class="text-blue-700 underline">{{ a.upload.name }}</a>
        <button data-url="{% url 'projekt_file_check_pk' a.pk %}" class="anlage-check-btn bg-green-600 text-white px-2 py-1 rounded ml-2">Prüfen</button>
        <a href="{% url 'projekt_file_edit_json' a.pk %}" class="inline-block bg-purple-600 text-white px-2 py-1 rounded ml-2">Analyse bearbeiten</a>
        {% if a.manual_comment %}<div class="italic">{{ a.manual_comment }}</div>{% endif %}
    </li>
    {% empty %}
    <li>Keine Anlagen vorhanden</li>
    {% endfor %}
</ul>
<a href="{% url 'projekt_file_upload' projekt.pk %}" class="bg-blue-600 text-white px-4 py-2 rounded">Anlage hochladen</a>
<div id="llm-section" class="mt-4"></div>
<script>
function getCookie(name){const m=document.cookie.match('(^|;)\\s*'+name+'=([^;]*)');return m?decodeURIComponent(m[2]):null;}

function loadLLM(){
 fetch('{% url 'project_detail_api' projekt.pk %}')
  .then(r=>r.json())
  .then(data=>renderLLM(data));
}

function renderLLM(data){
 const sec=document.getElementById('llm-section');
 sec.innerHTML='';
 if(!data.ist_llm_geprueft && !data.llm_initial_output){
   sec.innerHTML=`<button id="run" class="bg-green-600 text-white px-4 py-2 rounded">Run LLM Check (Initial)</button>`;
 }else if(data.ist_llm_geprueft && !data.llm_validated){
   sec.innerHTML=`<div class="text-red-600 mb-2">Initial LLM check incomplete or technically incorrect.</div>
   <textarea id="edit" class="border rounded w-full p-2 mb-2">${data.llm_initial_output||''}</textarea>
   <input id="context" type="text" placeholder="Additional context" class="border rounded w-full p-2 mb-2 hidden">
   <div class="space-x-2">
     <button id="edit-btn" class="bg-blue-600 text-white px-4 py-2 rounded">Edit Response & Recheck (Initial)</button>
     <button id="ctx-btn" class="bg-blue-600 text-white px-4 py-2 rounded">Add Additional Context & Recheck (Initial)</button>
   </div>`;
 }else if(data.ist_llm_geprueft && data.llm_validated){
   sec.innerHTML=`<button id="toggle" class="bg-green-600 text-white px-4 py-2 rounded mb-2">Show/Hide Initial LLM Response</button>
   <pre id="output" class="whitespace-pre-wrap bg-gray-100 p-2 rounded hidden">${data.llm_initial_output}</pre>`;
 }
 attachHandlers();
}

function attachHandlers(){
 const run=document.getElementById('run');
 if(run){run.addEventListener('click',()=>sendCheck({}));}
 const editBtn=document.getElementById('edit-btn');
 const ctxBtn=document.getElementById('ctx-btn');
 if(editBtn){
   editBtn.addEventListener('click',()=>{
     const text=document.getElementById('edit').value;
     sendCheck({edited_initial_output:text});
   });
 }
 if(ctxBtn){
   const ctxInput=document.getElementById('context');
   ctxBtn.addEventListener('click',()=>{
     if(ctxInput.classList.contains('hidden')){ctxInput.classList.remove('hidden');return;}
     if(ctxInput.value){sendCheck({additional_context:ctxInput.value});}
   });
 }
 const toggle=document.getElementById('toggle');
 if(toggle){
   toggle.addEventListener('click',()=>{
     document.getElementById('output').classList.toggle('hidden');
   });
 }
}

function sendCheck(payload){
 const sec=document.getElementById('llm-section');
 const spinner=document.createElement('span');
 spinner.textContent='...';
 sec.appendChild(spinner);
 fetch('{% url 'project_llm_check' projekt.pk %}',{
   method:'POST',
   headers:{'X-CSRFToken':getCookie('csrftoken')},
   body:new URLSearchParams(payload)
 }).then(r=>r.json()).then(d=>{if(d.error){alert(d.error);} loadLLM();}).catch(()=>alert('LLM-Prüfung fehlgeschlagen')).finally(()=>spinner.remove());
}

document.addEventListener('DOMContentLoaded',loadLLM);
document.addEventListener('DOMContentLoaded',()=>{
  document.querySelectorAll('.anlage-check-btn').forEach(btn=>{
    btn.addEventListener('click',ev=>{
      ev.preventDefault();
      fetch(btn.dataset.url,{method:'POST',headers:{'X-CSRFToken':getCookie('csrftoken')}})
      .then(r=>r.json()).then(d=>{
        if(d.status==='ok'){alert('Anlage geprüft');}else{alert('Fehler bei der Anlagenprüfung');}
      }).catch(()=>alert('Fehler bei der Anlagenprüfung'));
    });
  });
});
</script>
{% endblock %}
