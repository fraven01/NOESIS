{% extends 'user_base.html' %}
{% load recording_extras %}
{% block title %}Projekt {{ projekt.title }}{% endblock %}
{% block user_content %}
<h1 class="text-2xl font-semibold mb-4">{{ projekt.title }}
{% if is_admin %}
<a href="{% url 'admin_projects' %}" class="bg-red-600 text-white px-4 py-2 rounded ml-2">Admin</a>
{% endif %}
</h1>
<div class="lg:flex lg:space-x-4">
<div class="lg:w-2/3">
<p class="mb-2"><strong>Aktueller Status:</strong> {{ projekt.status.name }}</p>
<p class="mb-2"><strong>Beschreibung:</strong> {{ projekt.beschreibung|markdownify }}</p>
<p class="mb-2"><strong>Software-Typen:</strong> {{ projekt.software_string }}</p>
<form method="post" action="{% url 'projekt_status_update' projekt.pk %}" class="mb-4">
    {% csrf_token %}
    <label for="status" class="font-semibold">Status:</label>
    <select id="status" name="status" class="border rounded p-2">
    {% for s in status_choices %}
        <option value="{{ s.key }}" {% if projekt.status and projekt.status.key == s.key %}selected{% endif %}>{{ s.name }}</option>
    {% endfor %}
    </select>
    <button type="submit" class="bg-blue-600 text-white px-2 py-1 rounded ml-2">Aktualisieren</button>
</form>
<p class="mb-4">
    <a href="{% url 'projekt_gap_analysis' projekt.pk %}" class="text-blue-700 underline">Gap-Analyse herunterladen</a>
    |
    <a href="{% url 'projekt_management_summary' projekt.pk %}" class="text-blue-700 underline">Management Summary herunterladen</a>
</p>
<h2 class="text-xl font-semibold mt-4">Anlagen</h2>
<table class="mb-4 w-full text-left">
    <thead>
        <tr>
            <th class="px-2 py-1">Nr.</th>
            <th class="px-2 py-1">Datei</th>
            <th class="px-2 py-1 text-center">Prüfen</th>
            <th class="px-2 py-1 text-center">Analyse bearbeiten</th>
            <th class="px-2 py-1 text-center">Geprüft</th>
            <th class="px-2 py-1 text-center">Verhandlungsfähig</th>
        </tr>
    </thead>
    <tbody>
    {% for a in projekt.anlagen.all %}
        <tr class="border-t">
            <td class="px-2 py-1">{{ a.anlage_nr }}</td>
            <td class="px-2 py-1"><a href="{{ a.upload.url }}" class="text-blue-700 underline">Anlage {{ a.anlage_nr }}</a></td>
            <td class="px-2 py-1 text-center">
                <a href="{% url 'projekt_file_check_view' a.pk %}"
                   class="{% if a.analysis_json %}bg-green-600{% else %}bg-red-600{% endif %} text-white px-2 py-1 rounded">Prüfen</a>
                {% if a.anlage_nr == 2 %}
                    <a href="{% url 'projekt_file_parse_anlage2' a.pk %}"
                       class="bg-blue-600 text-white px-2 py-1 rounded ml-2">Parser</a>
                {% endif %}
            </td>
            <td class="px-2 py-1 text-center">
            {% if a.analysis_json %}
                <a href="{% url 'projekt_file_edit_json' a.pk %}"
                   class="bg-purple-600 text-white px-2 py-1 rounded">Analyse bearbeiten</a>
            {% endif %}
            </td>
            <td class="px-2 py-1 text-center">
                <form method="post" action="{% url 'project_file_toggle_flag' a.pk 'manual_reviewed' %}">
                    {% csrf_token %}
                    <input type="hidden" name="value" value="{{ a.manual_reviewed|yesno:'0,1' }}">
                    <button class="px-2 py-1 rounded {% if a.manual_reviewed %}bg-green-600 text-white{% else %}bg-gray-300{% endif %}">
                        {% if a.manual_reviewed %}✓{% else %}✗{% endif %}
                    </button>
                </form>
            </td>
            <td class="px-2 py-1 text-center">
                <form method="post" action="{% url 'project_file_toggle_flag' a.pk 'verhandlungsfaehig' %}">
                    {% csrf_token %}
                    <input type="hidden" name="value" value="{{ a.verhandlungsfaehig|yesno:'0,1' }}">
                    <button class="px-2 py-1 rounded {% if a.verhandlungsfaehig %}bg-green-600 text-white{% else %}bg-gray-300{% endif %}">
                        {% if a.verhandlungsfaehig %}✓{% else %}✗{% endif %}
                    </button>
                </form>
            </td>
        </tr>
    {% empty %}
        <tr><td colspan="6">Keine Anlagen vorhanden</td></tr>
    {% endfor %}
    </tbody>
</table>
<a href="{% url 'projekt_file_upload' projekt.pk %}" class="bg-blue-600 text-white px-4 py-2 rounded">Anlage hochladen</a>


<h2 class="text-xl font-semibold mt-4">Initial-Prüfung der Software-Komponenten</h2>
<table id="knowledge-table" class="mb-4 w-full text-left">
    <thead>
        <tr>
            <th class="px-2 py-1">Software</th>
            <th class="px-2 py-1 text-center">Bekannt?</th>
            <th class="px-2 py-1">Beschreibung</th>
            <th class="px-2 py-1 text-center">Aktionen</th>
            <th class="px-2 py-1 text-center">Gutachten</th>
        </tr>
    </thead>
    <tbody>
    {% for row in knowledge_rows %}
        <tr class="border-t" data-id="{{ row.entry.id|default:'' }}">
            <td class="px-2 py-1">{{ row.name }}</td>
            <td class="px-2 py-1 text-center">
                {% if row.entry and row.entry.is_known_by_llm is True %}
                    <span class="badge status-ja">✓ Bekannt</span>
                {% elif row.entry and row.entry.is_known_by_llm is False %}
                    <span class="badge status-nein">✗ Nicht bekannt</span>
                {% else %}
                    <span class="badge status-unbekannt">? Ungeprüft</span>
                {% endif %}
            </td>
            <td class="px-2 py-1">
                {% if row.entry and row.entry.is_known_by_llm is True %}
                    <div class="prose max-w-none">
                        {{ row.entry.description|markdownify }}
                    </div>
                {% elif row.entry and row.entry.is_known_by_llm is False %}
                    <p class="text-sm text-gray-500">Die automatische Prüfung konnte diese Software nicht eindeutig identifizieren. Bitte fügen Sie zusätzlichen Kontext hinzu, um die Prüfung zu wiederholen.</p>
                {% else %}
                {% endif %}
            </td>
            <td class="px-2 py-1 text-center space-x-2">
            {% if row.entry and row.entry.is_known_by_llm is True %}
                <a href="{% url 'edit_knowledge_description' row.entry.id %}" class="btn-action">Bearbeiten</a>
                <a href="{% url 'download_knowledge_as_word' row.entry.id %}" class="btn-action">Export</a>
                <a href="{% url 'delete_knowledge_entry' row.entry.id %}" class="btn-action-delete">Löschen</a>
            {% elif row.entry and row.entry.is_known_by_llm is False %}
                <button type="button" class="btn btn-warning btn-sm retry-with-context-btn" 
                        data-bs-toggle="modal" data-bs-target="#contextModal"
                        data-knowledge-id="{{ row.entry.id }}">
                    Kontext hinzufügen & erneut prüfen
                </button>
            {% else %}
                <button type="button" class="btn btn-primary btn-sm start-initial-check-btn" 
                         data-knowledge-id="{{ row.entry.id|default:'' }}">
                    Prüfung starten
                </button>
            {% endif %}
            </td>
            <td class="px-2 py-1 text-center">
            {% if row.entry %}
                {% if row.entry.gutachten %}
                    <a href="{% url 'gutachten_view' row.entry.gutachten.id %}">Anzeigen</a> |
                    <a href="{% url 'gutachten_edit' row.entry.gutachten.id %}">Bearbeiten</a> |
                    <a href="{% url 'gutachten_download' row.entry.gutachten.id %}">Download</a>
                {% else %}
                    <button class="btn btn-sm btn-primary generate-gutachten-btn" data-knowledge-id="{{ row.entry.id }}">
                        Gutachten erstellen
                    </button>
                {% endif %}
                <span class="gutachten-status-spinner ms-2" id="gutachten-status-{{ row.entry.id }}"></span>
            {% endif %}
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>
<button id="start-checks" class="bg-green-600 text-white px-4 py-2 rounded">Prüfung starten</button>

</div>
<div class="lg:w-1/3 mt-4 lg:mt-0">
  <div class="bg-gray-100 p-4 rounded">
    <h3 class="font-semibold mb-2">Projektinfo</h3>
    <p><strong>Erstellt am:</strong> {{ projekt.created_at|date:"d.m.Y" }}</p>
    <p class="mt-1"><strong>Software:</strong> {{ projekt.software_string }}</p>
    <p class="mt-1"><strong>Anlagen:</strong> {{ num_attachments }}</p>
    <p class="mt-1"><strong>Gutachten vorhanden:</strong> {% if projekt.gutachten_file %}Ja{% else %}Nein{% endif %}</p>
    <p class="mt-1"><strong>Geprüft:</strong> {{ num_reviewed }} / {{ num_attachments }}</p>
    <p class="mt-1"><strong>Initial-Prüfung:</strong> <span id="knowledge-progress">{{ knowledge_checked }} / {{ total_software }}</span> Komponenten analysiert</p>
    <h4 class="font-semibold mt-2">Status-Historie</h4>
    <ul class="list-disc pl-5">
    {% for h in history %}
      <li>{{ h.status.name }} - {{ h.changed_at|date:"d.m.Y H:i" }}</li>
    {% endfor %}
    </ul>
</div>
</div>
</div>

<!-- Modal für zusätzlichen Kontext -->
<div class="modal fade" id="contextModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Kontext hinzufügen</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <textarea id="contextText" class="form-control" rows="4"></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary send-context-btn">Senden</button>
      </div>
    </div>
  </div>
</div>
<script>
function getCookie(name){const m=document.cookie.match('(^|;)\s*'+name+'=([^;]*)');return m?decodeURIComponent(m[2]):null;}

function loadKnowledge(){
 fetch('{% url 'project_detail_api' projekt.pk %}')
  .then(r=>r.json())
  .then(data=>renderKnowledge(data));
}


function renderLLM(data){
 const sec=document.getElementById('llm-section');
 sec.innerHTML='';
 if(!data.ist_llm_geprueft && !data.llm_initial_output){
   sec.innerHTML=`<button id="run" class="bg-green-600 text-white px-4 py-2 rounded">LLM-Check starten</button>`;
 }else if(data.ist_llm_geprueft && !data.llm_validated){
   sec.innerHTML=`<div class="text-red-600 mb-2">LLM-Check unvollständig oder technisch fehlerhaft.</div>
   <textarea id="edit" class="border rounded w-full p-2 mb-2">${data.llm_initial_output||''}</textarea>
   <input id="context" type="text" placeholder="Weiterer Kontext" class="border rounded w-full p-2 mb-2 hidden">
   <div class="space-x-2">
     <button id="edit-btn" class="bg-blue-600 text-white px-4 py-2 rounded">Antwort bearbeiten & erneut prüfen</button>
     <button id="ctx-btn" class="bg-blue-600 text-white px-4 py-2 rounded">Zusätzlichen Kontext & erneut prüfen</button>
   </div>`;
 }else if(data.ist_llm_geprueft && data.llm_validated){
  sec.innerHTML=`<button id="toggle" class="bg-green-600 text-white px-4 py-2 rounded mb-2">Antwort ein-/ausblenden</button>
  <div id="output" class="prose max-w-none bg-gray-100 p-2 rounded hidden">${data.llm_initial_output_html}</div>`;
 }
 if(data.llm_initial_output){
   sec.innerHTML += `<button id="recheck" class="bg-blue-600 text-white px-4 py-2 rounded mt-2">Erneut prüfen</button>`;
 }
 attachHandlers();
}

function attachHandlers(){
 const run=document.getElementById('run');
 if(run){run.addEventListener('click',()=>sendCheck({}));}
 const editBtn=document.getElementById('edit-btn');
 const ctxBtn=document.getElementById('ctx-btn');
 if(editBtn){
   editBtn.addEventListener('click',()=>{
     const text=document.getElementById('edit').value;
     sendCheck({edited_initial_output:text});
   });
 }
 if(ctxBtn){
   const ctxInput=document.getElementById('context');
   ctxBtn.addEventListener('click',()=>{
     if(ctxInput.classList.contains('hidden')){ctxInput.classList.remove('hidden');return;}
     if(ctxInput.value){sendCheck({additional_context:ctxInput.value});}
   });
 }
 const toggle=document.getElementById('toggle');
 if(toggle){
  toggle.addEventListener('click',()=>{
    document.getElementById('output').classList.toggle('hidden');
  });
}
 const recheck=document.getElementById('recheck');
 if(recheck){recheck.addEventListener('click',()=>sendCheck({}));}

}

function startChecks(){
 const btn=document.getElementById('start-checks');
 btn.disabled=true;
 const spinner=document.createElement('span');
 spinner.textContent=' ...';
 btn.after(spinner);
 fetch('{% url 'ajax_start_initial_checks' projekt.pk %}',{
   method:'POST',
   headers:{'X-CSRFToken':getCookie('csrftoken')}
 }).then(r=>r.json()).then(data=>{
   const tasks=data.tasks||[];
   const tmpl='{% url "ajax_check_task_status" "dummy" %}';
   let done=0;
   tasks.forEach(t=>{
     const iv=setInterval(()=>{
       fetch(tmpl.replace('dummy',t.task_id)).then(r=>r.json()).then(d=>{
         if(d.status==='SUCCESS'||d.status==='FAIL'){
            clearInterval(iv);done++;
            if(done===tasks.length){window.location.reload();}
         }
       });
     },3000);
   });
 }).catch(()=>{alert('Fehler beim Start');spinner.remove();btn.disabled=false;});
}

document.addEventListener('DOMContentLoaded',loadKnowledge);
document.addEventListener('DOMContentLoaded',function(){
 const btn=document.getElementById('start-checks');
 if(btn){btn.addEventListener('click',startChecks);}
});

document.addEventListener('DOMContentLoaded',function(){
  document.querySelectorAll('.generate-gutachten-btn').forEach(button=>{
    button.addEventListener('click',function(event){
      event.preventDefault();
      const knowledgeId=this.dataset.knowledgeId;
      const url='{% url 'ajax_start_gutachten_generation' projekt.pk %}';
      const body=new FormData();
      body.append('knowledge_id',knowledgeId);

      this.classList.add('disabled');
      const status=document.getElementById('gutachten-status-'+knowledgeId);
      if(status){status.textContent='...';}

      fetch(url,{method:'POST',headers:{'X-CSRFToken':getCookie('csrftoken')},body:body})
        .then(r=>r.json()).then(data=>{
          const tid=data.task_id;
          const tmpl='{% url "ajax_check_task_status" "dummy" %}';
          const iv=setInterval(()=>{
            fetch(tmpl.replace('dummy',tid)).then(r=>r.json()).then(d=>{
              if(d.status==='SUCCESS'){
                clearInterval(iv);location.reload();
              }else if(d.status==='FAIL'){
                clearInterval(iv);
                if(status){status.textContent='Fehler';}
                button.classList.remove('disabled');
              }
            });
          },3000);
        }).catch(()=>{
          if(status){status.textContent='Fehler';}
          button.classList.remove('disabled');
  });
  });
});

document.addEventListener('DOMContentLoaded',function(){
  let contextId=null;
  document.querySelectorAll('.retry-with-context-btn').forEach(btn=>{
    btn.addEventListener('click',function(){
      contextId=this.dataset.knowledgeId;
      document.getElementById('contextText').value='';
    });
  });
  const sendBtn=document.querySelector('.send-context-btn');
  if(sendBtn){
    sendBtn.addEventListener('click',function(){
      const text=document.getElementById('contextText').value;
      const body=new FormData();
      body.append('knowledge_id',contextId);
      body.append('user_context',text);
      fetch('{% url "ajax_rerun_initial_check_with_context" %}',{method:'POST',headers:{'X-CSRFToken':getCookie('csrftoken')},body:body})
        .then(r=>r.json()).then(data=>{
          const tid=data.task_id;
          const tmpl='{% url "ajax_check_task_status" "dummy" %}';
          const iv=setInterval(()=>{
            fetch(tmpl.replace('dummy',tid)).then(r=>r.json()).then(d=>{
              if(d.status==='SUCCESS'||d.status==='FAIL'){
                clearInterval(iv);window.location.reload();
              }
            });
          },3000);
        });
      const modalEl=document.getElementById('contextModal');
      bootstrap.Modal.getInstance(modalEl).hide();
    });
  }
});
});
</script>
{% endblock %}
