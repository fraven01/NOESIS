{% extends 'base.html' %}
{% load static %}
{% load recording_extras ui_extras %}
{% block title %}Projekt {{ projekt.title }}{% endblock %}
{% block content %}
<h1 class="text-2xl font-semibold mb-4">{{ projekt.title }}
{% if is_admin %}
{% url 'admin_projects' as admin_url %}
{% include 'partials/_button.html' with href=admin_url label='Admin' variant='danger' classes='ml-2' %}
{% endif %}
</h1>
<div class="lg:flex lg:space-x-4">
<div class="w-full lg:w-2/3 space-y-6">
<div class="card">
<form id="status-update-form" method="post" action="{% url 'projekt_status_update' projekt.pk %}" class="mb-4 flex items-center space-x-2">
    {% csrf_token %}
    <label for="status" class="font-semibold">Status:</label>
    {% include 'partials/_form_select.html' with name='status' id='status' options=status_choices value=projekt.status.key classes='' %}

    {% include 'partials/_button.html' with id='status-update-btn' type='submit' label='Aktualisieren' variant='primary' classes='' %}

</form>
<p class="mb-4">
    <a href="{% url 'projekt_gap_analysis' projekt.pk %}" class="text-primary underline font-semibold inline-flex items-center">
        <span class="mr-1">&#x2B07;</span>Gap-Analyse herunterladen
    </a>
    |
    <a href="{% url 'projekt_management_summary' projekt.pk %}" class="text-primary underline font-semibold inline-flex items-center">
        <span class="mr-1">&#x2B07;</span>Management Summary herunterladen
    </a>
</p>
<p class="mb-4">
    {% if can_gap_report %}
    {% url 'projekt_gap_report' projekt.pk as gap_url %}
    {% include 'partials/_button.html' with id='gap-report-btn' href=gap_url label='GAP-Bericht für Fachbereich erstellen' variant='primary' %}
    {% else %}
    {% include 'partials/_button.html' with label='GAP-Bericht für Fachbereich erstellen' variant='disabled' disabled=True %}
    {% endif %}
</p>
</div>

<div class="card">
<h2 class="text-xl font-semibold mb-4">Anlagen</h2>
<nav class="flex space-x-2 mb-4" id="anlage-tabs-nav">
  {% for nr in anlage_numbers %}
  <button class="anlage-tab px-3 py-1 border-b-2 {% if forloop.first %}border-primary text-primary{% else %}border-transparent text-muted{% endif %}"
          hx-get="{% url 'hx_project_anlage_tab' projekt.pk nr %}"
          hx-target="#anlage-tab-content" hx-swap="innerHTML" hx-push-url="false"
          data-nr="{{ nr }}">
    Anlage {{ nr }}
  </button>
  {% endfor %}
</nav>
<div id="anlage-tab-content" hx-get="{% url 'hx_project_anlage_tab' projekt.pk 1 %}" hx-trigger="load"></div>
</div>


<div class="card">
<h2 class="text-xl font-semibold mb-4">Prüfungen</h2>
<div class="space-x-2">
    {% url 'projekt_initial_pruefung' projekt.pk as init_url %}
    {% include 'partials/_button.html' with href=init_url label='Initial-Prüfung und Gutachten' variant='primary' %}
</div>
</div>
</div>
<div class="hidden lg:block lg:w-1/3 mt-4 lg:mt-0">


  {% include 'partials/projekt_cockpit.html' %}

</div>
</div>

<script>


function loadKnowledge(){
 fetch('{% url 'project_detail_api' projekt.pk %}')
  .then(r=>r.json())
  .then(data=>renderKnowledge(data));
}


function renderLLM(data){
 const sec=document.getElementById('llm-section');
 sec.innerHTML='';
 if(!data.ist_llm_geprueft && !data.llm_initial_output){
   sec.innerHTML=`<button id="run" class="px-4 py-2 rounded {% btn_classes 'success' %}">LLM-Check starten</button>`;
 }else if(data.ist_llm_geprueft && !data.llm_validated){
    sec.innerHTML=`<div class="text-error mb-2">LLM-Check unvollständig oder technisch fehlerhaft.</div>
    <textarea id="edit" class="border-gray-300 dark:border-gray-600 bg-background dark:bg-background-dark text-text dark:text-text-light rounded w-full p-2 mb-2 focus:border-primary dark:focus:border-primary focus:ring-primary dark:focus:ring-primary focus:ring-offset-2 dark:focus:ring-offset-gray-800">${data.llm_initial_output||''}</textarea>
    <input id="context" type="text" placeholder="Weiterer Kontext" class="border-gray-300 dark:border-gray-600 bg-background dark:bg-background-dark text-gray-900 dark:text-gray-100 rounded w-full p-2 mb-2 hidden focus:border-primary dark:focus:border-primary focus:ring-primary dark:focus:ring-primary focus:ring-offset-2 dark:focus:ring-offset-gray-800">
    <div class="space-x-2">
     <button id="edit-btn" class="px-4 py-2 rounded {% btn_classes 'primary' %}">Antwort bearbeiten & erneut prüfen</button>
     <button id="ctx-btn" class="px-4 py-2 rounded {% btn_classes 'primary' %}">Zusätzlichen Kontext & erneut prüfen</button>
   </div>`;
 }else if(data.ist_llm_geprueft && data.llm_validated){
  sec.innerHTML=`<button id="toggle" class="px-4 py-2 rounded mb-2 {% btn_classes 'success' %}">Antwort ein-/ausblenden</button>
  <div id="output" class="prose dark:prose-invert max-w-none bg-background dark:bg-background-dark text-text dark:text-text-light border border-gray-300 dark:border-gray-600 p-2 rounded hidden">${data.llm_initial_output_html}</div>`;
 }
 if(data.llm_initial_output){
  sec.innerHTML += `<button id="recheck" class="px-4 py-2 rounded mt-2 {% btn_classes 'primary' %}">Erneut prüfen</button>`;
 }
 attachHandlers();
}

function attachHandlers(){
 const run=document.getElementById('run');
 if(run){run.addEventListener('click',()=>sendCheck({}));}
 const editBtn=document.getElementById('edit-btn');
 const ctxBtn=document.getElementById('ctx-btn');
 if(editBtn){
   editBtn.addEventListener('click',()=>{
     const text=document.getElementById('edit').value;
     sendCheck({edited_initial_output:text});
   });
 }
 if(ctxBtn){
   const ctxInput=document.getElementById('context');
   ctxBtn.addEventListener('click',()=>{
     if(ctxInput.classList.contains('hidden')){ctxInput.classList.remove('hidden');return;}
     if(ctxInput.value){sendCheck({additional_context:ctxInput.value});}
   });
 }
const toggle=document.getElementById('toggle');
if(toggle){
 toggle.addEventListener('click',()=>{
   document.getElementById('output').classList.toggle('hidden');
 });
}
const recheck=document.getElementById('recheck');
if(recheck){recheck.addEventListener('click',()=>sendCheck({}));}

 const start=document.getElementById('start-checks');
 if(start){start.addEventListener('click',startChecks);}

 const statusForm=document.getElementById('status-update-form');
 if(statusForm){
   statusForm.addEventListener('submit',()=>{
     const btn=document.getElementById('status-update-btn');
     showSpinner(btn,'Aktualisiere...');
   });
 }

 const gapBtn=document.getElementById('gap-report-btn');
 if(gapBtn){
   gapBtn.addEventListener('click',e=>{
     e.preventDefault();
     showSpinner(gapBtn,'Erstelle...');
     window.location=gapBtn.href;
   });
 }

  // Spinner für GAP-Berichte im Anlagen-Tab (HTMX-Content)
  document.querySelectorAll('.anlage-gap-btn').forEach(a=>{
    a.addEventListener('click',function(e){
      e.preventDefault();
      showSpinner(this, this.dataset.spinnerText || 'Wird geladen...');
      window.location = this.href;
    });
  });

 document.querySelectorAll('.generate-gutachten-btn').forEach(button=>{
   button.addEventListener('click',function(event){
     event.preventDefault();
     const knowledgeId=this.dataset.knowledgeId;
     const url='{% url 'ajax_start_gutachten_generation' projekt.pk %}';
     const body=new FormData();
     body.append('knowledge_id',knowledgeId);
     this.classList.add('disabled');
     const status=document.getElementById('gutachten-status-'+knowledgeId);
     showSpinner(this, 'Erstelle...');
     fetch(url,{method:'POST',headers:{'X-CSRFToken':getCookie('csrftoken')},body:body})
       .then(r=>r.json()).then(data=>{
         const tid=data.task_id;
         const tmpl='{% url "ajax_check_task_status" "dummy" %}';
         const iv=setInterval(()=>{
           fetch(tmpl.replace('dummy',tid)).then(r=>r.json()).then(d=>{
             if(d.status==='SUCCESS'){
               clearInterval(iv);location.reload();
             }else if(d.status==='FAIL'){
               clearInterval(iv);
               if(status){status.textContent='Fehler';}
               hideSpinner(button);
               button.classList.remove('disabled');
             }
           });
         },3000);
       }).catch(()=>{
         if(status){status.textContent='Fehler';}
         hideSpinner(button);
         button.classList.remove('disabled');
       });
   });
 });

 document.querySelectorAll('.retry-check-btn, .start-initial-check-btn').forEach(btn=>{
   btn.addEventListener('click',function(){
     const knowledgeId=this.dataset.knowledgeId;
     const body=new FormData();
     body.append('knowledge_id',knowledgeId);
     showSpinner(btn, 'Prüfung...');
     fetch('{% url "ajax_rerun_initial_check" %}',{method:'POST',headers:{'X-CSRFToken':getCookie('csrftoken')},body:body})
       .then(r=>r.json()).then(data=>{
         const tid=data.task_id;
         const tmpl='{% url "ajax_check_task_status" "dummy" %}';
         const iv=setInterval(()=>{
           fetch(tmpl.replace('dummy',tid)).then(r=>r.json()).then(d=>{
             if(d.status==='SUCCESS'||d.status==='FAIL'){
               clearInterval(iv);window.location.reload();
             }
           });
         },3000);
       }).catch(()=>{hideSpinner(btn);});
   });
 });

}

function startChecks(){
 const btn=document.getElementById('start-checks');
 showSpinner(btn, 'Prüfung läuft...');
 fetch('{% url 'ajax_start_initial_checks' projekt.pk %}',{
   method:'POST',
   headers:{'X-CSRFToken':getCookie('csrftoken')}
 }).then(r=>r.json()).then(data=>{
   const tasks=data.tasks||[];
   const tmpl='{% url "ajax_check_task_status" "dummy" %}';
   let done=0;
   tasks.forEach(t=>{
     const iv=setInterval(()=>{
       fetch(tmpl.replace('dummy',t.task_id)).then(r=>r.json()).then(d=>{
         if(d.status==='SUCCESS'||d.status==='FAIL'){
            clearInterval(iv);done++;
            if(done===tasks.length){window.location.reload();}
         }
       });
     },3000);
   });
 }).catch(()=>{alert('Fehler beim Start'); hideSpinner(btn);});
}

document.addEventListener('DOMContentLoaded',loadKnowledge);
document.addEventListener('DOMContentLoaded',attachHandlers);

document.addEventListener('htmx:afterSwap',function(){
  attachHandlers();
});

document.addEventListener('htmx:beforeRequest',function(e){
  const t=e.target;
  if(t.classList.contains('anlage-tab')){
    document.querySelectorAll('.anlage-tab').forEach(b=>{
      b.classList.remove('border-primary','text-primary');
      b.classList.add('border-transparent','text-muted');
    });
    t.classList.remove('border-transparent','text-muted');
    t.classList.add('border-primary','text-primary');
  }
  if(t.classList.contains('software-tab')){
    document.querySelectorAll('.software-tab').forEach(b=>{
      b.classList.remove('border-primary','text-primary');
      b.classList.add('border-transparent','text-muted');
    });
    t.classList.remove('border-transparent','text-muted');
    t.classList.add('border-primary','text-primary');
  }
});
</script>
<script type="module" src="{% static 'js/anlagen_dropzone.js' %}"></script>
{% endblock %}
